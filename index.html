<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background:#f7f9fc; }
    .form-section { border: 1px solid #ccc; padding: 12px; margin: 12px; background:#fff; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    input, select, textarea { padding: 6px; margin: 3px; border: 1px solid #bbb; border-radius: 4px; }
    .btn { padding: 7px 16px; margin: 5px; background: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #0056b3; }

    /* âœ… PAGE STYLE (Each page like A4 sheet) */
    .invoice-page {
      width: 210mm;
      min-height: 297mm;
      margin: auto;
      padding: 12mm;
      border: 2px solid #444;
      background:#fff;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .header { text-align: center; border-bottom:2px solid #444; padding-bottom:8px; margin-bottom:12px; position:relative; }
    .header img { position:absolute; left:0; top:10px; width:100px; height:auto; }

    /* âœ… TAX INVOICE SMALL + INFRA SKYNET LARGE */
    h2 { margin: 2px 0; font-size:14px; letter-spacing:1px; color:#333; }
    .company-details { font-size: 14px; line-height: 1.5; color:#555; }
    .company-details b { font-size: 20px; color:#000; }

    table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
    table, th, td { border: 1px solid #444; padding: 6px; text-align: center; }
    th { background:#f2f2f2; }
    .no-border { border: none !important; }
    .left { text-align: left; }
    .right { text-align: right; }
    .term  { text-align: left; font-size: 10px; }
    .sign-box { height: 60px; vertical-align: bottom; }
    .highlight { background:#f9fbff; }

    
/* âœ… Compact Header Table Layout */
.top-head-table td{
  padding: 3px 6px !important;
  font-size: 12px !important;
  line-height: 1.2 !important;
}

/* âœ… Remove inside border (no double border) */
.top-head-inner,
.top-head-inner tr,
.top-head-inner td{
  border: none !important;
}

.top-head-inner td{
  padding: 2px 4px !important;
  font-size: 12px !important;
  line-height: 1.2 !important;
}

/* âœ… No extra box border needed */
.top-head-box{
  border: none !important;
  padding: 0 !important;
}

.bill-ship-box{
  padding: 4px 6px !important;
  font-size: 12px !important;
  line-height: 1.25 !important;
}



    /* Label */
    .copy-label {
      position:absolute;
      top:10px;
      right:15px;
      font-weight:bold;
      font-size:14px;
      border:1px solid #000;
      padding:2px 8px;
      background:#fff;
    }

    /* Continued footer */
    .continued-note{
      position:absolute;
      bottom:8mm;
      right:12mm;
      font-size:12px;
      font-weight:bold;
      color:#333;
    }

    @page {
      size: A4;
      margin: 8mm;
    }

    @media print {
      body { margin: 0; background:#fff; }
      .form-section, .btn-area { display: none; }

      .invoice-page {
        width: 100%;
        min-height: 297mm;
        margin: 0;
        page-break-after: always;
        break-after: page;
      }

      .invoice-page:last-child {
        page-break-after: auto;
        break-after: auto;
      }
    }
  </style>
</head>
<body>

<script>
  if (sessionStorage.getItem("loggedIn") !== "true") {
    window.location.href = "login.html";
  }
</script>

<div style="position:absolute; top:15px; right:20px;">
  <button onclick="ut()" style="padding:8px 14px; background:#dc3545; border:none; color:#fff; border-radius:5px; cursor:pointer;">
    ðŸšª Logout
  </button>
</div>

<script>
function ut() {
  sessionStorage.removeItem("loggedIn");
  window.location.href = "login.html";
}
</script>

<h2 style="text-align:center; font-size:22px;">Invoice Creation</h2>

<!-- FORM -->
<div class="form-section">
  <iframe src="https://docs.google.com/spreadsheets/d/1niBY8qiTx_uTHudPvjPCnOI8jXpY4veX/edit?usp=sharing&ouid=113391954839419332435&rtpof=true&sd=true"
        style="width:100%; height:600px; border:1px solid #ccc;">
  </iframe>

  <a href="https://drive.google.com/drive/folders/1dSXs1nsdIbKU8Z6Pid5Qmn8T2v6fSsm6?usp=drive_link"
     target="_blank"
     style="display:inline-block; padding:12px 20px; background:#007bff; color:#fff; border-radius:6px; text-decoration:none;">
     ðŸ“‚ Open Invoice Folder (Google Drive)
  </a>

  <h3>Invoice Details</h3>
  Invoice No: <input id="invNo" value="ISN/25-26/">
  Date: <input type="date" id="invDate">
  Place of Supply: <input id="place" value="Faridabad"><br><br>

  State Code: <input id="stateCode" value=""><br><br>

  PO No: <input id="poNo" value="">
  PO Date: <input type="date" id="poDate">
  E-Waybill: <input id="poStateCode" value="">
  Challan No: <input id="challanNo" value=""><br><br>

  <b>GST Type:</b>
  <select id="gstType" onchange="toggleGST()">
    <option value="intra">Intra-State (CGST + SGST)</option>
    <option value="inter">Inter-State (IGST)</option>
  </select><br>

  <div id="intraRates">
    CGST %: <input type="number" id="cgstRate" value="9" style="width:50px;">
    SGST %: <input type="number" id="sgstRate" value="9" style="width:50px;">
  </div>
  <div id="interRates" style="display:none;">
    IGST %: <input type="number" id="igstRate" value="18" style="width:50px;">
  </div><br>

  <b>Invoice Copy Type:</b>
  <select id="copyType">
    <option value="ORIGINAL">Original</option>
    <option value="DUPLICATE">Duplicate</option>
    <option value="TRIPLICATE">Triplicate</option>
  </select>

  <br><br>
  <b>Manual Round Off (Optional):</b>
  <input type="number" id="manualRoundOff" step="0.01" value="" placeholder="Example: -0.25 or 0.50">
</div>

<div class="form-section">
  <h3>Customer Details</h3>
  <b>Bill To</b><br>
  Name: <input id="billName" value=""><br>
  Address: <textarea id="billAddr"></textarea><br>
  GSTIN: <input id="billGST" value=""><br><br>

  <b>Ship To</b><br>
  Name: <input id="shipName" value=""><br>
  Address: <textarea id="shipAddr"></textarea><br>
  GSTIN: <input id="shipGST" value=""><br>
</div>

<div class="form-section">
  <h3>Products:</h3><h4>Note: Do not add more than 7 products per page. Adding more than 7 will automatically move the extra items to the next page.</h4>
  <div id="items">
    <div class="item">
      Description: <input class="desc" value="">
      HSN: <input class="hsn" value="">
      Qty: <input type="number" class="qty" value="">
      Unit: <input class="unit" value="NOS">
      Rate: <input type="number" class="rate" value="">
    </div>
  </div>
  <button type="button" class="btn" onclick="addItem()">+ Add Item</button>
</div>

<div class="btn-area" style="text-align:center;">
  <button class="btn" onclick="generateInvoice()">Generate Invoice</button>
</div>

<div class="form-section">
  <h3>Upload Signature</h3>
  <input type="file" id="sigUpload" accept="image/*">
</div>

<!-- âœ… OUTPUT WRAPPER -->
<div id="invoiceWrapper" style="display:none;"></div>

<div class="btn-area" id="actionBtns" style="display:none; text-align:center;">
  <button class="btn" onclick="printInvoice()">ðŸ–¨ Print</button>
  <button class="btn" onclick="downloadPDF()">â¬‡ Download PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<script>
function toggleGST() {
  const gstType = document.getElementById("gstType").value;
  document.getElementById("intraRates").style.display = (gstType === "intra") ? "block" : "none";
  document.getElementById("interRates").style.display = (gstType === "inter") ? "block" : "none";
}

function addItem() {
  const div = document.createElement('div');
  div.className = "item";
  div.innerHTML = `Description: <input class="desc">
    HSN: <input class="hsn">
    Qty: <input type="number" class="qty" value="1">
    Unit: <input class="unit" value="NOS">
    Rate: <input type="number" class="rate" value="0">`;
  document.getElementById('items').appendChild(div);
}

/* âœ… create page template (repeated header/company block on every page) */
function getInvoiceHeaderHTML(copyType) {
  return `
    <div class="copy-label">${copyType}</div>
    <div class="header">
      <img src="/logo.jpeg" alt="Company Logo">
      <h2>TAX INVOICE</h2>
      <div class="company-details">
        <b>INFRA SKYNET</b><br>
        Udyam Reg. No : UDYAM-HR-03-0093322<br>
        GSTIN : 06JECPM7950A1ZJ<br>
        Plot No-118 Bhagat Singh Colony, Ballabhgarh, Faridabad<br>
        Tel: +91 7042200401 | Email: info@infraskynet.com
      </div>
    </div>
  `;
}

/* âœ… Updated Header Block as per your image */
function getTopDetailsTableHTML(data) {
  return `
  <table class="top-head-table">
    <tr>
      <!-- LEFT BOX -->
      <td class="left" style="width:50%; vertical-align:top;">
        <table class="top-head-inner" style="width:100%; border-collapse:collapse;">
          <tr><td class="left no-border">Invoice No.</td><td class="no-border">:</td><td class="left no-border">${data.invNo}</td></tr>
          <tr><td class="left no-border">Date</td><td class="no-border">:</td><td class="left no-border">${data.invDate}</td></tr>
          <tr><td class="left no-border">Place Of Supply</td><td class="no-border">:</td><td class="left no-border">${data.place}</td></tr>
          <tr><td class="left no-border">State Code</td><td class="no-border">:</td><td class="left no-border">${data.stateCode}</td></tr>
        </table>
      </td>

      <!-- RIGHT BOX -->
      <td class="left" style="width:50%; vertical-align:top;">
        <table class="top-head-inner" style="width:100%; border-collapse:collapse;">
          <tr><td class="left no-border">PO No</td><td class="no-border">:</td><td class="left no-border">${data.poNo}</td></tr>
          <tr><td class="left no-border">PO Date</td><td class="no-border">:</td><td class="left no-border">${data.poDate}</td></tr>
          <tr><td class="left no-border">E-Waybill</td><td class="no-border">:</td><td class="left no-border">${data.poStateCode}</td></tr>
          <tr><td class="left no-border">Challan No</td><td class="no-border">:</td><td class="left no-border">${data.challanNo}</td></tr>
        </table>
      </td>
    </tr>

    <tr>
      <td class="left bill-ship-box" style="width:50%; vertical-align:top;">
        <b>Billed to :</b><br><br>
        ${data.billName}<br>
        ${data.billAddr}<br><br>
        <b>GSTIN / UIN :</b> ${data.billGST}
      </td>

      <td class="left bill-ship-box" style="width:50%; vertical-align:top;">
        <b>Ship to :</b><br><br>
        ${data.shipName}<br>
        ${data.shipAddr}<br><br>
        <b>GSTIN / UIN :</b> ${data.shipGST}
      </td>
    </tr>
  </table>
  `;
}



/* âœ… COMMON FOOTER (Bank + Signature + Terms) ON EVERY PAGE */
function getCommonFooterHTML() {
  return `
    <table>
      <tr>
        <td class="left">
          <b>Bank Details</b><br>
          Bank: State Bank of India<br>
          A/C No: 43060919412<br>
          Branch: Chawala Colony Mathura Colony, Ballabhgarh Faridabad Haryana<br>
          IFSC: SBIN0001157
        </td>
        <td class="right sign-box">
          <b>Authorised Signatory</b><br>
          <img class="sigOut" src="" alt="" style="max-width:150px; max-height:60px; display:none;">
        </td>
      </tr>
    </table>

    <table>
      <tr>
        <td class="term">
          <b>Term & Condition</b><br>
          <ol>
            <li>Goods once sold will not taken back.</li>
            <li>Warranty is provided as per OEM terms. No warranty from us.</li>
            <li>No warranty claims for goods damaged in transit.</li>
            <li>â‚¹500 charge for any cheque return.</li>
            <li>24% p.a interest if payment is delayed.</li>
          </ol>
        </td>
      </tr>
    </table>

    <div style="text-align:center; margin-top:10px; font-size:12px; color:#555;">
      This is a computer generated invoice.
    </div>
  `;
}

function generateInvoice() {
  const copyType = document.getElementById('copyType').value;

  const data = {
    invNo: document.getElementById('invNo').value,
    invDate: document.getElementById('invDate').value || new Date().toLocaleDateString(),
    place: document.getElementById('place').value,

    stateCode: document.getElementById('stateCode').value,

    poNo: document.getElementById('poNo').value,
    poDate: document.getElementById('poDate').value,
    poStateCode: document.getElementById('poStateCode').value,
    challanNo: document.getElementById('challanNo').value,

    billName: document.getElementById('billName').value,
    billAddr: document.getElementById('billAddr').value,
    billGST: document.getElementById('billGST').value,

    shipName: document.getElementById('shipName').value,
    shipAddr: document.getElementById('shipAddr').value,
    shipGST: document.getElementById('shipGST').value,
  };

  const items = Array.from(document.querySelectorAll('#items .item')).map((row) => {
    const desc = row.querySelector('.desc').value;
    const hsn = row.querySelector('.hsn').value;
    const qty = parseFloat(row.querySelector('.qty').value) || 0;
    const unit = row.querySelector('.unit').value;
    const rate = parseFloat(row.querySelector('.rate').value) || 0;
    const amt = qty * rate;
    return { desc, hsn, qty, unit, rate, amt };
  });

  // âœ… Split items into pages (safe limit)
  const itemsPerPage = 7; 
  const pages = [];
  for (let i = 0; i < items.length; i += itemsPerPage) {
    pages.push(items.slice(i, i + itemsPerPage));
  }

  // âœ… Calculate totals
  let total = items.reduce((sum, it) => sum + it.amt, 0);

  const gstType = document.getElementById('gstType').value;
  const cgstRate = parseFloat(document.getElementById('cgstRate').value) || 0;
  const sgstRate = parseFloat(document.getElementById('sgstRate').value) || 0;
  const igstRate = parseFloat(document.getElementById('igstRate').value) || 0;

  let totalTax = 0;
  let taxRows = "";

  if (gstType === "intra") {
    const cgst = total * (cgstRate/100);
    const sgst = total * (sgstRate/100);
    totalTax = cgst + sgst;
    taxRows += `<tr><td class="left no-border">CGST @ ${cgstRate}%:</td><td class="right">${cgst.toFixed(2)}</td></tr>`;
    taxRows += `<tr><td class="left no-border">SGST @ ${sgstRate}%:</td><td class="right">${sgst.toFixed(2)}</td></tr>`;
  } else {
    const igst = total * (igstRate/100);
    totalTax = igst;
    taxRows += `<tr><td class="left no-border">IGST @ ${igstRate}%:</td><td class="right">${igst.toFixed(2)}</td></tr>`;
  }

  let grand = total + totalTax;

  taxRows += `<tr><td class="left no-border"><b>Total Tax Amount:</b></td><td class="right"><b>${totalTax.toFixed(2)}</b></td></tr>`;

  // Round Off manual/auto
  const manualRoundOffVal = document.getElementById('manualRoundOff').value;
  const manualRoundOff = manualRoundOffVal !== "" ? parseFloat(manualRoundOffVal) : null;

  let roundedGrand = Math.round(grand);
  let roundOff = roundedGrand - grand;

  if (manualRoundOff !== null && !isNaN(manualRoundOff)) {
    roundOff = manualRoundOff;
    roundedGrand = Math.round(grand + roundOff);
  }

  if (Math.abs(roundOff) >= 0.01) {
    taxRows += `<tr><td class="left no-border">Round Off:</td><td class="right">${roundOff.toFixed(2)}</td></tr>`;
  }

  taxRows += `<tr class="highlight"><td class="left no-border"><b>Grand Total:</b></td><td class="right"><b>â‚¹${roundedGrand}</b></td></tr>`;

  // âœ… Build pages HTML
  const wrapper = document.getElementById("invoiceWrapper");
  wrapper.innerHTML = "";

  pages.forEach((pageItems, pageIndex) => {
    const page = document.createElement("div");
    page.className = "invoice-page";

    // âœ… Header and Top Details on every page
    page.innerHTML += getInvoiceHeaderHTML(copyType);
    page.innerHTML += getTopDetailsTableHTML(data);

    // Products table
    let tableRows = `
      <table>
        <tr>
          <th>S.N.</th>
          <th>Description of Goods</th>
          <th>HSN/SAC</th>
          <th>Qty</th>
          <th>Unit</th>
          <th>Rate</th>
          <th>Amount</th>
        </tr>
    `;

    pageItems.forEach((it, idx) => {
      const sn = pageIndex * itemsPerPage + idx + 1;
      tableRows += `
        <tr>
          <td>${sn}</td>
          <td>${it.desc}</td>
          <td>${it.hsn}</td>
          <td>${it.qty}</td>
          <td>${it.unit}</td>
          <td>${it.rate.toFixed(2)}</td>
          <td>${it.amt.toFixed(2)}</td>
        </tr>
      `;
    });

    tableRows += `</table>`;
    page.innerHTML += tableRows;

    // âœ… LAST PAGE
    if (pageIndex === pages.length - 1) {
      page.innerHTML += `<table>${taxRows}</table>`;
      page.innerHTML += `
        <div style="margin-top:10px;">
          <i>Amount Chargeable (in words):</i><br>
          <span>${numberToWords(roundedGrand)} Only</span>
        </div>
      `;
      page.innerHTML += getCommonFooterHTML();
    } else {
      // âœ… OTHER PAGES (footer common)
      page.innerHTML += getCommonFooterHTML();
      page.innerHTML += `<div class="continued-note">Continued...</div>`;
    }

    wrapper.appendChild(page);
  });

  // âœ… Signature show on every page
  const sigImg = document.getElementById("sigImage");
  if (sigImg && sigImg.src) {
    document.querySelectorAll(".sigOut").forEach(img => {
      img.src = sigImg.src;
      img.style.display = "block";
    });
  }

  wrapper.style.display = "block";
  document.getElementById('actionBtns').style.display="block";
}

// Number to Words (Indian System)
function numberToWords(num) {
  if (num === 0) return "Zero";

  const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
             'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen',
             'Seventeen', 'Eighteen', 'Nineteen'];
  const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

  function inWords(n) {
    if (n < 20) return a[n];
    if (n < 100) return b[Math.floor(n / 10)] + (n % 10 ? " " + a[n % 10] : "");
    if (n < 1000) return a[Math.floor(n / 100)] + " Hundred " + (n % 100 ? inWords(n % 100) : "");
    return "";
  }

  function indianNumberSystem(n) {
    let str = "";
    const crore = Math.floor(n / 10000000); n %= 10000000;
    const lakh = Math.floor(n / 100000); n %= 100000;
    const thousand = Math.floor(n / 1000); n %= 1000;
    const hundred = n;

    if(crore) str += inWords(crore) + " Crore ";
    if(lakh) str += inWords(lakh) + " Lakh ";
    if(thousand) str += inWords(thousand) + " Thousand ";
    if(hundred) str += inWords(hundred);
    return str.trim();
  }

  return indianNumberSystem(num);
}

function printInvoice() {
  window.print();
}

function downloadPDF() {
  const element = document.getElementById('invoiceWrapper');
  html2pdf().from(element).set({
    margin: 0,
    filename: 'Invoice.pdf',
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).save();
}

document.getElementById('sigUpload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    const img = document.getElementById('sigImage');
    if (!img) return;

    img.src = event.target.result;
    img.style.display = "block";
  }
  reader.readAsDataURL(file);
});
</script>

<!-- hidden signature for storing -->
<img id="sigImage" src="" style="display:none;">

</body>
</html>
